{
  ArrayList<FeatureLayer> layers=new ArrayList<FeatureLayer>();
  for (int i=0; i < features.size(); i++) {
    FeatureCollection collection=(FeatureCollection)features.get(i);
    layers.add(new FeatureLayer(collection,null));
  }
  for (  FeatureLayer l : layers) {
    String title=l.getFeatureSource().getName().getLocalPart();
    l.setTitle(title);
  }
  StyleBuilder stb=new StyleBuilder();
  for (  FeatureLayer l : layers) {
    LayerInfo layerInfo=wms.getLayerByName(l.getTitle());
    Style style=null;
    if (layerInfo != null) {
      Set<StyleInfo> styles_u=layerInfo.getStyles();
      for (      StyleInfo s : styles_u) {
        style=s.getStyle();
        if (style != null) {
          break;
        }
      }
      if (style == null) {
        style=layerInfo.getDefaultStyle().getStyle();
      }
    }
 else {
      throw new ServiceException("Could not find layer " + l.getTitle(),"LayerNotDefined");
    }
    l.setStyle(style);
  }
  return (FeatureLayer[])layers.toArray(new FeatureLayer[0]);
}
