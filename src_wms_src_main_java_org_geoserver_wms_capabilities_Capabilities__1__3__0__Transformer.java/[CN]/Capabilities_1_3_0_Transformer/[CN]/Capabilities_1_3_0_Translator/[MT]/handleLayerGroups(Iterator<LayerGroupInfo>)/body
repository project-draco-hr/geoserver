{
  Set<LayerInfo> layersAlreadyProcessed=new HashSet<LayerInfo>();
  if (layerGroups == null) {
    return layersAlreadyProcessed;
  }
  List<LayerGroupInfo> topLevelGroups=filterNestedGroups(layerGroups);
  for (  LayerGroupInfo group : topLevelGroups) {
    try {
      mark();
      handleLayerGroup(group,layersAlreadyProcessed);
      commit();
    }
 catch (    Exception e) {
      if (skipping) {
        reset();
      }
 else {
        throw new ServiceException("Error occurred trying to write out metadata for layer group: " + group.getName(),e);
      }
    }
  }
  return layersAlreadyProcessed;
}
