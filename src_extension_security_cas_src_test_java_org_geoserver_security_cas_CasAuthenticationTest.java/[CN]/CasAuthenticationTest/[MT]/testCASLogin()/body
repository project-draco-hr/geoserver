{
  String casFilterName="testCasFilter1";
  CasAuthenticationFilterConfig config=new CasAuthenticationFilterConfig();
  config.setClassName(GeoServerCasAuthenticationFilter.class.getName());
  config.setService(serviceUrl.toString());
  config.setCasServerUrlPrefix(casServerURLPrefix.toString());
  config.setName(casFilterName);
  config.setUserGroupServiceName("ug1");
  getSecurityManager().saveFilter(config);
  String casExceptionTranslationFilter="casExceptionTranslationFilter1";
  ExceptionTranslationFilterConfig exConfig=new ExceptionTranslationFilterConfig();
  exConfig.setClassName(GeoServerExceptionTranslationFilter.class.getName());
  exConfig.setName(casExceptionTranslationFilter);
  exConfig.setAccessDeniedErrorPage("/denied.jsp");
  exConfig.setAuthenticationFilterName(casFilterName);
  getSecurityManager().saveFilter(exConfig);
  prepareFilterChain("/j_spring_cas_security_check",GeoServerSecurityFilterChain.SECURITY_CONTEXT_ASC_FILTER,casFilterName);
  pattern="/web/**";
  prepareFilterChain(pattern,GeoServerSecurityFilterChain.SECURITY_CONTEXT_ASC_FILTER,casExceptionTranslationFilter,GeoServerSecurityFilterChain.FILTER_SECURITY_INTERCEPTOR);
  SecurityContextHolder.getContext().setAuthentication(null);
  MockHttpServletRequest request=createRequest("web");
  MockHttpServletResponse response=new MockHttpServletResponse();
  MockFilterChain chain=new MockFilterChain();
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  assertTrue(response.wasRedirectSent());
  String redirectURL=response.getHeader("Location");
  assertTrue(redirectURL.contains("login"));
  assertTrue(redirectURL.endsWith("j_spring_cas_security_check"));
  String username="castest";
  String password=username;
  CasFormAuthenticationHelper helper=new CasFormAuthenticationHelper(casServerURLPrefix,username,password);
  helper.ssoLogin();
  request=createRequest("/j_spring_cas_security_check");
  String ticket=helper.getServiceTicket(new URL(request.getRequestURL().toString()));
  request.setQueryString("ticket=" + ticket);
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.setupAddParameter("ticket",ticket);
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  assertTrue(response.wasRedirectSent());
  String redirectUrl=response.getHeader("Location");
  assertNotNull(redirectUrl);
  SecurityContext ctx=(SecurityContext)request.getSession(false).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNotNull(ctx);
  Authentication auth=ctx.getAuthentication();
  assertNotNull(auth);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  checkForAuthenticatedRole(auth);
  assertEquals(username,((UserDetails)auth.getPrincipal()).getUsername());
  assertTrue(auth.getAuthorities().contains(new GeoServerRole(rootRole)));
  assertTrue(auth.getAuthorities().contains(new GeoServerRole(derivedRole)));
  assertNotNull(GeoServerCasAuthenticationFilter.getHandler().getSessionMappingStorage().removeSessionByMappingId(ticket));
  helper.ssoLogout();
  username="unknown";
  password=username;
  helper=new CasFormAuthenticationHelper(casServerURLPrefix,username,password);
  helper.ssoLogin();
  request=createRequest("/j_spring_cas_security_check");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  ticket=helper.getServiceTicket(new URL(request.getRequestURL().toString()));
  request.setupAddParameter("ticket",ticket);
  request.setQueryString("ticket=" + ticket);
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNotNull(ctx);
  auth=ctx.getAuthentication();
  assertNotNull(auth);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  checkForAuthenticatedRole(ctx.getAuthentication());
  assertEquals(username,((UserDetails)auth.getPrincipal()).getUsername());
  assertEquals(1,auth.getAuthorities().size());
  assertNotNull(GeoServerCasAuthenticationFilter.getHandler().getSessionMappingStorage().removeSessionByMappingId(ticket));
  helper.ssoLogout();
  username=GeoServerUser.ROOT_USERNAME;
  password=username;
  helper=new CasFormAuthenticationHelper(casServerURLPrefix,username,password);
  helper.ssoLogin();
  request=createRequest("/j_spring_cas_security_check");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  ticket=helper.getServiceTicket(new URL(request.getRequestURL().toString()));
  request.setupAddParameter("ticket",ticket);
  request.setQueryString("ticket=" + ticket);
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  assertTrue(response.wasRedirectSent());
  assertTrue(response.getHeader("Location").endsWith(GeoServerUserNamePasswordAuthenticationFilter.URL_LOGIN_SUCCCESS));
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  auth=ctx.getAuthentication();
  assertNotNull(auth);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  assertEquals(GeoServerUser.ROOT_USERNAME,((UserDetails)auth.getPrincipal()).getUsername());
  assertTrue(auth.getAuthorities().size() == 1);
  assertTrue(auth.getAuthorities().contains(GeoServerRole.ADMIN_ROLE));
  assertNotNull(GeoServerCasAuthenticationFilter.getHandler().getSessionMappingStorage().removeSessionByMappingId(ticket));
  helper.ssoLogout();
  username="castest";
  password=username;
  helper=new CasFormAuthenticationHelper(casServerURLPrefix,username,password);
  helper.ssoLogin();
  updateUser("ug1",username,false);
  request=createRequest("/j_spring_cas_security_check");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  ticket=helper.getServiceTicket(new URL(request.getRequestURL().toString()));
  request.setupAddParameter("ticket",ticket);
  request.setQueryString("ticket=" + ticket);
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  assertTrue(response.wasRedirectSent());
  redirectURL=response.getHeader("Location");
  assertTrue(redirectURL.contains("login"));
  assertTrue(redirectURL.endsWith("j_spring_cas_security_check"));
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNull(ctx);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  assertNull(GeoServerCasAuthenticationFilter.getHandler().getSessionMappingStorage().removeSessionByMappingId(ticket));
  updateUser("ug1",username,true);
  helper.ssoLogout();
  insertAnonymousFilter(casExceptionTranslationFilter);
  request=createRequest("foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  removeAnonymousFilter();
  username="castest";
  password=username;
  helper=new CasFormAuthenticationHelper(casServerURLPrefix,username,password);
  helper.ssoLogin();
  request=createRequest("/j_spring_cas_security_check");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  ticket=helper.getServiceTicket(new URL(request.getRequestURL().toString()));
  ticket+="ST-A";
  request.setupAddParameter("ticket",ticket);
  request.setQueryString("ticket=" + ticket);
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  assertTrue(response.wasRedirectSent());
  redirectURL=response.getHeader("Location");
  assertTrue(redirectURL.contains("login"));
  assertTrue(redirectURL.endsWith("j_spring_cas_security_check"));
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNull(ctx);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  assertNull(GeoServerCasAuthenticationFilter.getHandler().getSessionMappingStorage().removeSessionByMappingId(ticket));
  helper.ssoLogout();
  config.setProxyCallbackUrlPrefix(proxyCallbackUrlPrefix.toString());
  getSecurityManager().saveFilter(config);
  username="castest";
  password=username;
  helper=new CasFormAuthenticationHelper(casServerURLPrefix,username,password);
  helper.ssoLogin();
  request=createRequest("/j_spring_cas_security_check");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  ticket=helper.getServiceTicket(new URL(request.getRequestURL().toString()));
  request.setupAddParameter("ticket",ticket);
  request.setQueryString("ticket=" + ticket);
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  assertTrue(response.wasRedirectSent());
  redirectUrl=response.getHeader("Location");
  assertNotNull(redirectUrl);
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNotNull(ctx);
  CasAuthenticationToken casAuth=(CasAuthenticationToken)ctx.getAuthentication();
  assertNotNull(casAuth);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  checkForAuthenticatedRole(casAuth);
  assertEquals(username,((UserDetails)casAuth.getPrincipal()).getUsername());
  assertTrue(casAuth.getAuthorities().contains(new GeoServerRole(rootRole)));
  assertTrue(casAuth.getAuthorities().contains(new GeoServerRole(derivedRole)));
  String proxyTicket=casAuth.getAssertion().getPrincipal().getProxyTicketFor("http://localhost/blabla");
  assertNotNull(proxyTicket);
  assertNotNull(GeoServerCasAuthenticationFilter.getHandler().getSessionMappingStorage().removeSessionByMappingId(ticket));
  helper.ssoLogout();
}
