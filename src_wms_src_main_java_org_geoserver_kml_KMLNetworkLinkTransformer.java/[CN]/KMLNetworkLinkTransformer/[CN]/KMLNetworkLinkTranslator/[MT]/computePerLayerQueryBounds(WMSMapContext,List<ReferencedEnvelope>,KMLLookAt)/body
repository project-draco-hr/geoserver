{
  final boolean computeQueryBounds=lookAt.getLookAt() == null;
  ReferencedEnvelope aggregatedBounds;
  try {
    boolean longitudeFirst=true;
    aggregatedBounds=new ReferencedEnvelope(CRS.decode("EPSG:4326",longitudeFirst));
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  aggregatedBounds.setToNull();
  final MapLayer[] mapLayers=context.getLayers();
  final List<MapLayerInfo> layerInfos=context.getRequest().getLayers();
  for (int i=0; i < mapLayers.length; i++) {
    final MapLayer mapLayer=mapLayers[i];
    final MapLayerInfo layerInfo=layerInfos.get(i);
    ReferencedEnvelope layerLatLongBbox;
    layerLatLongBbox=computeLayerBounds(mapLayer,layerInfo,computeQueryBounds);
    try {
      layerLatLongBbox=layerLatLongBbox.transform(aggregatedBounds.getCoordinateReferenceSystem(),true);
    }
 catch (    Exception e) {
      throw new RuntimeException(e);
    }
    target.add(layerLatLongBbox);
    aggregatedBounds.expandToInclude(layerLatLongBbox);
  }
  return aggregatedBounds;
}
