{
  GetMapRequest request=mapContent.getRequest();
  boolean cachedMode="cached".equals(KMLUtils.getSuperoverlayMode(request,wms));
  List<MapLayerInfo> layers=request.getLayers();
  List<ReferencedEnvelope> layerBounds=new ArrayList<ReferencedEnvelope>(mapContent.layers().size());
  computePerLayerQueryBounds(mapContent,layerBounds,null);
  List<Style> styles=request.getStyles();
  for (int i=0; i < layers.size(); i++) {
    MapLayerInfo layer=layers.get(i);
    if (cachedMode && KMLUtils.isRequestGWCCompatible(request,i,wms)) {
      encodeGWCLink(container,request,layer);
    }
 else {
      String styleName=i < styles.size() ? styles.get(i).getName() : null;
      ReferencedEnvelope bounds=layerBounds.get(i);
      encodeLayerSuperOverlay(container,request,layer,styleName,i,bounds);
    }
  }
}
