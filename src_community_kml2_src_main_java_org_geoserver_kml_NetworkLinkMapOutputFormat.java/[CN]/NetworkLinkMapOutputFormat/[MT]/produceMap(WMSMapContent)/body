{
  GetMapRequest request=mapContent.getRequest();
  if (NetworkLinkMapOutputFormat.KML_MIME_TYPE.equals(request.getFormat())) {
    request.setFormat(KMLMapOutputFormat.MIME_TYPE);
  }
 else {
    request.setFormat(KMZMapOutputFormat.MIME_TYPE);
  }
  Kml kml=new Kml();
  Document document=kml.createAndSetDocument();
  Map formatOptions=request.getFormatOptions();
  String kmltitle=(String)formatOptions.get("kmltitle");
  Folder folder=document.createAndAddFolder();
  folder.setName(kmltitle);
  Boolean superoverlay=(Boolean)formatOptions.get("superoverlay");
  if (superoverlay == null) {
    superoverlay=Boolean.FALSE;
  }
  if (superoverlay) {
    encodeAsSuperOverlay(folder,mapContent);
  }
 else {
    encodeAsOverlay(folder,mapContent);
  }
  boolean kmz=request.getFormat().equals(KMZ_MIME_TYPE) || request.getFormat().equals(KMZMapOutputFormat.MIME_TYPE);
  String mime=kmz ? KMZMapOutputFormat.MIME_TYPE : KMLMapOutputFormat.MIME_TYPE;
  KMLMap map=new KMLMap(mapContent,null,kml,mime);
  map.setContentDispositionHeader(mapContent,".kml");
  return map;
}
