{
  final String layerName=li.getResource().getPrefixedName();
  final GeoServerTileLayer tileLayer;
  tileLayer=(GeoServerTileLayer)catalogConfig.getTileLayer(layerName);
  boolean save=false;
  if (changedProperties.contains("defaultStyle")) {
    final int propIndex=changedProperties.indexOf("defaultStyle");
    final StyleInfo oldStyle=(StyleInfo)oldValues.get(propIndex);
    final StyleInfo newStyle=(StyleInfo)newValues.get(propIndex);
    final String oldStyleName=oldStyle.getName();
    final String newStyleName=newStyle.getName();
    if (!oldStyleName.equals(newStyleName)) {
      save=true;
      catalogConfig.truncate(layerName,oldStyleName);
    }
  }
  if (changedProperties.contains("styles")) {
    final GeoServerTileLayerInfo info=tileLayer.getInfo();
    final int propIndex=changedProperties.indexOf("styles");
    final Set<StyleInfo> oldStyles=(Set<StyleInfo>)oldValues.get(propIndex);
    final Set<StyleInfo> currentStyles=(Set<StyleInfo>)newValues.get(propIndex);
    Set<String> newStyleSet=new HashSet<String>(info.getCachedStyles());
    if (!oldStyles.equals(currentStyles)) {
      Set<StyleInfo> removed=new HashSet<StyleInfo>(oldStyles);
      removed.removeAll(currentStyles);
      for (      StyleInfo deletedStyle : removed) {
        String styleName=deletedStyle.getName();
        newStyleSet.remove(styleName);
        catalogConfig.truncate(layerName,styleName);
      }
      if (info.isAutoCacheStyles()) {
        Set<StyleInfo> added=new HashSet<StyleInfo>(currentStyles);
        added.removeAll(oldStyles);
        for (        StyleInfo addedStyle : added) {
          String styleName=addedStyle.getName();
          newStyleSet.add(styleName);
        }
      }
    }
    Set<String> currentStyleNames=new HashSet<String>();
    for (    StyleInfo current : currentStyles) {
      currentStyleNames.add(current.getName());
    }
    newStyleSet.retainAll(currentStyleNames);
    if (!newStyleSet.equals(info.getCachedStyles())) {
      save=true;
      info.setCachedStyles(newStyleSet);
      tileLayer.resetParameterFilters();
    }
  }
  if (save) {
    catalogConfig.save(tileLayer);
  }
}
