{
  int x=0, y=0;
  Catalog catalog=findCatalog(mapContext);
  FontMetrics metrics=g2d.getFontMetrics(g2d.getFont().deriveFont(Font.BOLD));
  double scaleDenominator=RendererUtilities.calculateOGCScale(mapContext.getAreaOfInterest(),mapContext.getRequest().getWidth(),null);
  for (  Layer layer : mapContext.layers()) {
    SimpleFeatureType type=(SimpleFeatureType)layer.getFeatureSource().getSchema();
    if (!isGridLayer(type)) {
      try {
        Dimension legend=getLegendSize(type,layer.getStyle(),scaleDenominator,g2d);
        x=Math.max(x,(int)legend.width);
        x=Math.max(x,TITLE_INDENT + metrics.stringWidth(findTitle(layer,catalog)));
        y+=legend.height + metrics.getHeight();
      }
 catch (      Exception e) {
        LOGGER.log(Level.WARNING,"Error sizing legend for " + layer);
        continue;
      }
    }
 else {
      LOGGER.log(Level.FINE,"Skipping raster layer: " + layer);
    }
  }
  x+=metrics.getDescent();
  return new Dimension(x,y);
}
