{
  final SimpleFeature sampleFeature=createSampleFeature(layer);
  final FeatureTypeStyle[] ftStyles=style.getFeatureTypeStyles();
  final Rule[] applicableRules=LegendUtils.getApplicableRules(ftStyles,scaleDenominator);
  final NumberRange<Double> scaleRange=NumberRange.create(scaleDenominator,scaleDenominator);
  final int ruleCount=applicableRules.length;
  final int w=20;
  final int h=20;
  FontMetrics metrics=g2d.getFontMetrics();
  AffineTransform oldTransform=g2d.getTransform();
  Composite oldComposite=g2d.getComposite();
  float totalHeight=0, totalWidth=0;
  for (int i=0; i < ruleCount; i++) {
    final Symbolizer[] symbolizers=applicableRules[i].getSymbolizers();
    for (int sIdx=0; sIdx < symbolizers.length; sIdx++) {
      final Symbolizer symbolizer=symbolizers[sIdx];
      if (symbolizer instanceof RasterSymbolizer) {
        throw new IllegalStateException("It is not legal to have a RasterSymbolizer here");
      }
 else {
        Style2D style2d=styleFactory.createStyle(sampleFeature,symbolizer,scaleRange);
        LiteShape2 shape=getSampleShape(symbolizer,w,h);
        if (style2d != null) {
          shapePainter.paint(g2d,shape,style2d,scaleDenominator);
        }
      }
    }
    String label=applicableRules[i].getTitle();
    if (label == null)     label=applicableRules[i].getName();
    if (label == null)     label="";
    g2d.setColor(Color.BLACK);
    g2d.setComposite(AlphaComposite.SrcOver);
    g2d.drawString(label,h + metrics.getDescent(),metrics.getHeight());
    float heightIncrement=Math.max(h,metrics.getHeight());
    g2d.translate(0,heightIncrement);
    totalHeight=totalHeight + heightIncrement;
    totalWidth=Math.max(totalWidth,w + metrics.getDescent() + metrics.stringWidth(label));
  }
  g2d.setTransform(oldTransform);
  g2d.setComposite(oldComposite);
  return new Dimension((int)totalWidth,(int)totalHeight);
}
