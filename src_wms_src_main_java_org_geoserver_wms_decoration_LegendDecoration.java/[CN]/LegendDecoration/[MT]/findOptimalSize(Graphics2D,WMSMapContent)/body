{
  int x=0, y=0;
  Catalog catalog=findCatalog(mapContent);
  FontMetrics metrics=g2d.getFontMetrics(g2d.getFont().deriveFont(Font.BOLD));
  double scaleDenominator=RendererUtilities.calculateOGCScale(mapContent.getRenderingArea(),mapContent.getRequest().getWidth(),null);
  for (  Layer layer : mapContent.layers()) {
    SimpleFeatureType type=(SimpleFeatureType)layer.getFeatureSource().getSchema();
    if (!isGridLayer(type)) {
      try {
        Dimension legend=getLegendSize(type,layer.getStyle(),scaleDenominator,g2d);
        x=Math.max(x,(int)legend.width);
        y+=legend.height;
        String title=findTitle(layer,catalog);
        if (title != null) {
          x=Math.max(x,TITLE_INDENT + metrics.stringWidth(title));
          y+=metrics.getHeight();
        }
      }
 catch (      Exception e) {
        LOGGER.log(Level.WARNING,"Error sizing legend for " + layer);
        continue;
      }
    }
 else {
      LOGGER.log(Level.FINE,"Skipping raster layer: " + layer);
    }
  }
  x+=metrics.getDescent();
  return new Dimension(x,y);
}
