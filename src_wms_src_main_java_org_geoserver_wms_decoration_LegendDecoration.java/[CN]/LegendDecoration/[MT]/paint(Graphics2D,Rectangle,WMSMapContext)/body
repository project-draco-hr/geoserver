{
  Catalog catalog=wms.getGeoServer().getCatalog();
  Dimension d=findOptimalSize(g2d,mapContext);
  Rectangle bgRect=new Rectangle(0,0,d.width,d.height);
  double scaleDenominator=RendererUtilities.calculateOGCScale(mapContext.getAreaOfInterest(),mapContext.getRequest().getWidth(),new HashMap());
  Color oldColor=g2d.getColor();
  AffineTransform oldTransform=(AffineTransform)g2d.getTransform().clone();
  Font oldFont=g2d.getFont();
  Stroke oldStroke=g2d.getStroke();
  g2d.translate(paintArea.getX(),paintArea.getY());
  AffineTransform tx=new AffineTransform();
  FontMetrics metrics=g2d.getFontMetrics(g2d.getFont().deriveFont(Font.BOLD));
  double scaleFactor=(paintArea.getWidth() / d.getWidth());
  scaleFactor=Math.min(scaleFactor,paintArea.getHeight() / d.getHeight());
  if (scaleFactor < 1.0) {
    g2d.scale(scaleFactor,scaleFactor);
  }
  AffineTransform bgTransform=g2d.getTransform();
  g2d.setColor(bgcolor);
  g2d.fill(bgRect);
  g2d.setColor(fgcolor);
  for (  Layer layer : mapContext.layers()) {
    SimpleFeatureType type=(SimpleFeatureType)layer.getFeatureSource().getSchema();
    if (!isGridLayer(type)) {
      try {
        g2d.translate(0,metrics.getHeight());
        g2d.setFont(g2d.getFont().deriveFont(Font.BOLD));
        g2d.drawString(findTitle(layer,catalog),TITLE_INDENT,0 - metrics.getDescent());
        g2d.setFont(g2d.getFont().deriveFont(Font.PLAIN));
        Dimension dim=drawLegend(type,layer.getStyle(),scaleDenominator,g2d);
        g2d.translate(0,dim.getHeight());
      }
 catch (      Exception e) {
        LOGGER.log(Level.WARNING,"Couldn't make a legend for " + type.getName(),e);
      }
    }
 else {
      LOGGER.log(Level.FINE,"Skipping raster layer " + type.getName() + " in legend decoration");
    }
  }
  g2d.setTransform(bgTransform);
  g2d.setStroke(new BasicStroke(1));
  g2d.draw(new Rectangle(bgRect.x,bgRect.y,bgRect.width - 1,bgRect.height - 1));
  g2d.setStroke(oldStroke);
  g2d.setTransform(oldTransform);
  g2d.setFont(oldFont);
  g2d.setColor(oldColor);
}
