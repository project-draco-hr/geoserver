{
  GetMapRequest request=mapContent.getRequest();
  String bilEncoding=(String)request.getFormat();
  int height=request.getHeight();
  int width=request.getWidth();
  if ((height > 512) || (width > 512)) {
    throw new ServiceException("Cannot get WMS bil" + " tiles bigger than 512x512, try WCS");
  }
  List<MapLayerInfo> reqlayers=request.getLayers();
  if (reqlayers.size() > 1) {
    throw new ServiceException("Cannot combine layers into BIL output");
  }
  MapLayerInfo mapLayerInfo=reqlayers.get(0);
  GridCoverageReader coverageReader=mapLayerInfo.getCoverageReader();
  GridCoverage2D subCov=null;
  try {
    subCov=getFinalCoverage(request,mapLayerInfo,(GridCoverage2DReader)coverageReader);
  }
 catch (  IndexOutOfBoundsException e) {
    e.printStackTrace();
  }
catch (  FactoryException e) {
    e.printStackTrace();
  }
catch (  TransformException e) {
    e.printStackTrace();
  }
  if (subCov != null) {
    image=subCov.getRenderedImage();
    if (image != null) {
      int dtype=image.getData().getDataBuffer().getDataType();
      RenderedOp formcov=null;
      if ((bilEncoding.equals("application/bil32")) && (dtype != DataBuffer.TYPE_FLOAT)) {
        formcov=FormatDescriptor.create(image,DataBuffer.TYPE_FLOAT,null);
      }
      if ((bilEncoding.equals("application/bil16")) && (dtype != DataBuffer.TYPE_SHORT)) {
        formcov=FormatDescriptor.create(image,DataBuffer.TYPE_SHORT,null);
      }
      if ((bilEncoding.equals("application/bil8")) && (dtype != DataBuffer.TYPE_BYTE)) {
        formcov=FormatDescriptor.create(image,DataBuffer.TYPE_BYTE,null);
      }
      TiledImage tiled=null;
      if (formcov != null)       tiled=new TiledImage(formcov,width,height);
 else       tiled=new TiledImage(image,width,height);
      final ImageOutputStream imageOutStream=ImageIO.createImageOutputStream(outStream);
      final ImageWriter writer=writerSPI.createWriterInstance();
      writer.setOutput(imageOutStream);
      writer.write(tiled);
      imageOutStream.flush();
      imageOutStream.close();
    }
 else {
      throw new ServiceException("Cannot render to BIL");
    }
  }
 else {
    throw new ServiceException("You requested a bil of size:" + height + "x"+ width+ ",but you can't have it!!");
  }
}
