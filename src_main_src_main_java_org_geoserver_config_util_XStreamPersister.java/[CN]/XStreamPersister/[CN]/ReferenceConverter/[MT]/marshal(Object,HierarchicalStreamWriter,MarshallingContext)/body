{
  source=CatalogImpl.unwrap(source);
  String id=(String)OwsUtils.get(source,"id");
  if (id != null && !referenceByName) {
    writer.startNode("id");
    writer.setValue(id);
    writer.endNode();
    callback.postEncodeReference(source,id,writer,context);
  }
 else {
    String name=(String)OwsUtils.get(source,"name");
    if (name != null) {
      writer.startNode("name");
      writer.setValue(name);
      writer.endNode();
      callback.postEncodeReference(source,name,writer,context);
    }
 else {
      throw new IllegalArgumentException("Unable to marshal reference with no id or name.");
    }
  }
}
