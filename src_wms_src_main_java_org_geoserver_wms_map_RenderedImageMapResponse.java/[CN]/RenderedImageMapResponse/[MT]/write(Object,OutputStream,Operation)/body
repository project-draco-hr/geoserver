{
  Assert.isInstanceOf(RenderedImageMap.class,value);
  final RenderedImageMap imageMap=(RenderedImageMap)value;
  try {
    final RenderedImage image=imageMap.getImage();
    final List<GridCoverage2D> renderedCoverages=imageMap.getRenderedCoverages();
    final WMSMapContext mapContext=imageMap.getMapContext();
    try {
      formatImageOutputStream(image,output,mapContext);
      output.flush();
    }
  finally {
      for (      GridCoverage2D coverage : renderedCoverages) {
        coverage.dispose(true);
      }
      if (image instanceof PlanarImage) {
        ImageUtilities.disposePlanarImageChain((PlanarImage)image);
      }
 else       if (image instanceof BufferedImage) {
        ((BufferedImage)image).flush();
      }
    }
  }
  finally {
    imageMap.dispose();
  }
}
