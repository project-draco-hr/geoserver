{
  SecurityUserGroupServiceConfig config=getSecurityManager().loadUserGroupServiceConfig(service.getName());
  config.setPasswordEncoderName(getPlainTextPasswordEncoder().getName());
  getSecurityManager().saveUserGroupService(config);
  service.initializeFromConfig(config);
  store=service.createStore();
  store.addUser(store.createUserObject("u1","p1",true));
  store.addUser(store.createUserObject("u2","p2",true));
  store.store();
  Util.recodePasswords(service.createStore());
  assertTrue(service.loadUserByUsername("u1").getPassword().startsWith(getPlainTextPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u2").getPassword().startsWith(getPlainTextPasswordEncoder().getPrefix()));
  config.setPasswordEncoderName(getPBEPasswordEncoder().getName());
  getSecurityManager().saveUserGroupService(config);
  service.initializeFromConfig(config);
  Util.recodePasswords(service.createStore());
  assertTrue(service.loadUserByUsername("u1").getPassword().startsWith(getPBEPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u2").getPassword().startsWith(getPBEPasswordEncoder().getPrefix()));
  config.setPasswordEncoderName(getDigestPasswordEncoder().getName());
  getSecurityManager().saveUserGroupService(config);
  service.initializeFromConfig(config);
  Util.recodePasswords(service.createStore());
  assertTrue(service.loadUserByUsername("u1").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u2").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  config.setPasswordEncoderName(getPBEPasswordEncoder().getName());
  getSecurityManager().saveUserGroupService(config);
  service.initializeFromConfig(config);
  Util.recodePasswords(service.createStore());
  assertTrue(service.loadUserByUsername("u1").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u2").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  store=service.createStore();
  store.addUser(store.createUserObject("u3","p3",true));
  store.store();
  assertTrue(service.loadUserByUsername("u1").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u2").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u3").getPassword().startsWith(getPBEPasswordEncoder().getPrefix()));
  config.setPasswordEncoderName(getEmptyEncoder().getName());
  getSecurityManager().saveUserGroupService(config);
  service.initializeFromConfig(config);
  Util.recodePasswords(service.createStore());
  assertTrue(service.loadUserByUsername("u1").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u2").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u3").getPassword().startsWith(getEmptyEncoder().getPrefix()));
  config.setPasswordEncoderName(getPBEPasswordEncoder().getName());
  getSecurityManager().saveUserGroupService(config);
  service.initializeFromConfig(config);
  Util.recodePasswords(service.createStore());
  assertTrue(service.loadUserByUsername("u1").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u2").getPassword().startsWith(getDigestPasswordEncoder().getPrefix()));
  assertTrue(service.loadUserByUsername("u3").getPassword().startsWith(getEmptyEncoder().getPrefix()));
}
