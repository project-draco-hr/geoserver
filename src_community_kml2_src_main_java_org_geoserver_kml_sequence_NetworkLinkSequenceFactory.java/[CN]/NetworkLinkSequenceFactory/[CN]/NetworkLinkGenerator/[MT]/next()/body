{
  while (i < size) {
    WMSMapContent mapContent=context.getMapContent();
    List<Layer> layers=mapContent.layers();
    Layer layer=layers.get(i++);
    context.setCurrentLayer(layer);
    NetworkLink nl=new NetworkLink();
    nl.setName(layer.getTitle());
    nl.setName(layer.getTitle());
    nl.setVisibility(true);
    nl.setOpen(true);
    GetMapRequest request=context.getRequest();
    request.setBbox(null);
    if (KMLMapOutputFormat.NL_KML_MIME_TYPE.equals(request.getFormat())) {
      request.setFormat(KMLMapOutputFormat.MIME_TYPE);
    }
 else {
      request.setFormat(KMZMapOutputFormat.MIME_TYPE);
    }
    String href=WMSRequests.getGetMapUrl(request,layer,KMLUtils.getLayerIndex(mapContent,layer),null,null);
    try {
      href=URLDecoder.decode(href,"UTF-8");
    }
 catch (    UnsupportedEncodingException e) {
      throw new RuntimeException(e);
    }
    Link url=nl.createAndSetUrl();
    url.setHref(href);
    url.setViewRefreshMode(ViewRefreshMode.ON_STOP);
    url.setViewRefreshTime(1);
    for (    KmlDecorator decorator : decorators) {
      nl=(NetworkLink)decorator.decorate(nl,context);
      if (nl == null) {
        continue;
      }
    }
    return nl;
  }
  return null;
}
