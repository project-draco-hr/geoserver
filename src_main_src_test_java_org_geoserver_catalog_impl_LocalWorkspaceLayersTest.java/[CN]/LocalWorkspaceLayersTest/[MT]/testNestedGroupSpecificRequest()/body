{
  CatalogFactory factory=catalog.getFactory();
  LayerGroupInfo nestedGroup=factory.createLayerGroup();
  nestedGroup.setName(NESTED_GROUP);
  nestedGroup.getLayers().add(getBridgesLayer());
  catalog.add(nestedGroup);
  LayerGroupInfo globalGroup=factory.createLayerGroup();
  globalGroup.setName(GLOBAL_GROUP);
  globalGroup.getLayers().add(getBuildingsLayer());
  globalGroup.getLayers().add(getAggregateGeoFeatureLayer());
  globalGroup.getLayers().add(nestedGroup);
  catalog.add(globalGroup);
  LocalPublished.set(catalog.getLayerGroupByName(GLOBAL_GROUP));
  assertNull(catalog.getLayerByName(getLayerId(SystemTestData.BASIC_POLYGONS)));
  assertNotNull(getBridgesLayer());
  assertNotNull(getBuildingsLayer());
  assertNotNull(getAggregateGeoFeatureLayer());
  assertNotNull(catalog.getLayerGroupByName(NESTED_GROUP));
  assertNotNull(catalog.getLayerGroupByName(GLOBAL_GROUP));
  assertThat(catalog.getLayers(),containsInAnyOrder(getBuildingsLayer(),getAggregateGeoFeatureLayer(),getBridgesLayer()));
  Request request=new Request();
  request.setService("WMS");
  request.setRequest("GetCapabilities");
  Dispatcher.REQUEST.set(request);
  assertNull(catalog.getLayerByName(getLayerId(SystemTestData.BASIC_POLYGONS)));
  assertNull(getBridgesLayer());
  assertNull(catalog.getLayerGroupByName(NESTED_GROUP));
  assertNull(getBuildingsLayer());
  assertNull(getAggregateGeoFeatureLayer());
  assertNotNull(catalog.getLayerGroupByName(GLOBAL_GROUP));
  assertEquals(0,catalog.getLayers().size());
  globalGroup=catalog.getLayerGroupByName(GLOBAL_GROUP);
  globalGroup.setMode(Mode.NAMED);
  catalog.save(globalGroup);
  assertNull(catalog.getLayerByName(getLayerId(SystemTestData.BASIC_POLYGONS)));
  assertNotNull(getBridgesLayer());
  assertNotNull(catalog.getLayerGroupByName(NESTED_GROUP));
  assertNotNull(getBuildingsLayer());
  assertNotNull(getAggregateGeoFeatureLayer());
  assertNotNull(catalog.getLayerGroupByName(GLOBAL_GROUP));
  assertThat(catalog.getLayers(),containsInAnyOrder(getBuildingsLayer(),getAggregateGeoFeatureLayer(),getBridgesLayer()));
  LocalPublished.remove();
}
