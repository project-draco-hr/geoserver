{
  Style style=pm.createAndAddStyle();
  IconStyle is=style.createAndSetIconStyle();
  is.setColorMode(ColorMode.NORMAL);
  Icon icon=is.createAndSetIcon();
  String iconHref=null;
  Mark mark=SLD.mark(symbolizer);
  if (mark != null && mark.getFill() != null) {
    Fill fill=mark.getFill();
    Double opacity=fill.getOpacity().evaluate(sf,Double.class);
    if (opacity == null || Double.isNaN(opacity)) {
      opacity=1.0;
    }
    if (fill != null) {
      final Color color=(Color)fill.getColor().evaluate(sf,Color.class);
      is.setColor(KMLUtils.colorToHex(color,opacity));
    }
  }
  ExternalGraphic graphic=getExternalGraphic(symbolizer);
  if (graphic != null) {
    try {
      URL graphicLocation=graphic.getLocation();
      iconHref=graphicLocation.toString();
      iconHref=evaluateDynamicSymbolizer(iconHref,sf);
      graphicLocation=new URL(iconHref);
      String graphicProtocol=new URL(iconHref).getProtocol();
      if ("file".equals(graphicProtocol)) {
        File file=DataUtilities.urlToFile(graphicLocation);
        File styles=null;
        File graphicFile=null;
        if (file.isAbsolute()) {
          GeoServerDataDirectory dataDir=(GeoServerDataDirectory)GeoServerExtensions.bean("dataDirectory");
          styles=dataDir.findOrCreateStyleDir().getCanonicalFile();
          graphicFile=file.getCanonicalFile();
          file=graphicFile;
          if (file.getAbsolutePath().startsWith(styles.getAbsolutePath())) {
            file=new File(file.getAbsolutePath().substring(styles.getAbsolutePath().length() + 1));
          }
 else {
            file=null;
          }
        }
        if (file != null && styles != null) {
          iconHref=ResponseUtils.buildURL(context.getRequest().getBaseUrl(),"styles/" + styles.toURI().relativize(graphicFile.toURI()),null,URLType.RESOURCE);
        }
 else {
          iconHref=null;
        }
      }
 else       if (!("http".equals(graphicProtocol) || "https".equals(graphicProtocol))) {
        iconHref=null;
      }
    }
 catch (    Exception e) {
      LOGGER.log(Level.WARNING,"Error processing external graphic:" + graphic,e);
    }
  }
  if (iconHref == null) {
    iconHref="http://maps.google.com/mapfiles/kml/pal4/icon25.png";
  }
  icon.setHref(iconHref);
}
