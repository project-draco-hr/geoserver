{
  KMLMap kmlMap=(KMLMap)value;
  try {
    KmlEncodingContext context=kmlMap.getKmlEncodingContext();
    Kml kml=kmlMap.getKml();
    if (context != null && context.isKmz()) {
      encodeAsKmz(kml,context,operation,output);
    }
 else {
      new KMLEncoder().encode(kml,output);
    }
  }
  finally {
    kmlMap.dispose();
  }
}
