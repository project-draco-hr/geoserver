{
  while (i < size) {
    List<Layer> layers=context.getMapContent().layers();
    Layer layer=layers.get(i++);
    context.setCurrentLayer(layer);
    if (layer instanceof FeatureLayer) {
      try {
        WMSMapContent mapContent=context.getMapContent();
        SimpleFeatureCollection fc=KMLUtils.loadFeatureCollection((SimpleFeatureSource)layer.getFeatureSource(),layer,mapContent,context.getWms(),mapContent.getScaleDenominator());
        context.setCurrentFeatureCollection(fc);
      }
 catch (      Exception e) {
        if (e instanceof ServiceException) {
          throw (ServiceException)e;
        }
 else {
          throw new ServiceException("Failed to load vector data during KML generation",e);
        }
      }
    }
    Folder folder=new Folder();
    folder.setName(layer.getTitle());
    for (    KmlDecorator decorator : decorators) {
      folder=(Folder)decorator.decorate(folder,context);
      if (folder == null) {
        continue;
      }
    }
    if (layer instanceof FeatureLayer) {
      if (useVectorOutput(context.getCurrentFeatureCollection())) {
        List<Feature> features=new SequenceList<Feature>(new FeatureSequenceFactory(context,(FeatureLayer)layer));
        addFeatures(folder,features);
      }
 else {
        addGroundOverlay(folder,layer);
        if (context.isPlacemarkForced()) {
          addFeatureCentroids(layer,folder);
        }
      }
    }
 else {
      addGroundOverlay(folder,layer);
    }
    return folder;
  }
  return null;
}
