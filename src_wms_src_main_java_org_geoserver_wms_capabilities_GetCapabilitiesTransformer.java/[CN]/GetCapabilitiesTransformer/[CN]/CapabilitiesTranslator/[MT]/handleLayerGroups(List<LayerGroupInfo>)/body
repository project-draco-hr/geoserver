{
  Set<LayerInfo> layersAlreadyProcessed=new HashSet<LayerInfo>();
  if (layerGroups == null || layerGroups.size() == 0) {
    return layersAlreadyProcessed;
  }
  List<LayerGroupInfo> topLevelGropus=filterNestedGroups(layerGroups);
  for (  LayerGroupInfo layerGroup : topLevelGropus) {
    try {
      mark();
      handleLayerGroup(layerGroup,layersAlreadyProcessed);
      commit();
    }
 catch (    Exception e) {
      if (skipping) {
        reset();
      }
 else {
        throw new ServiceException("Error occurred trying to write out metadata for layer group: " + layerGroup.getName(),e);
      }
    }
  }
  return layersAlreadyProcessed;
}
