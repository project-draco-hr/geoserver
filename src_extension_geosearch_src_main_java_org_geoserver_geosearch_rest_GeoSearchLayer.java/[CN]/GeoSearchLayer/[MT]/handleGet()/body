{
  final WMS wms=new WMS(geoserver){
    @Override public GetMapOutputFormat getMapOutputFormat(    final String mimeType){
      return new GetMapSnatcher();
    }
  }
;
  GetMapKvpRequestReader reader=new GetMapKvpRequestReader(wms);
  reader.setHttpRequest(RESTUtils.getServletRequest(getRequest()));
  GetMapRequest getMapRequest=getRequest(layer);
  final String title;
  final String description;
  String[] keywords={};
  if (layer instanceof LayerInfo) {
    LayerInfo layerInfo=(LayerInfo)layer;
    title=layerInfo.getResource().getTitle();
    description=layerInfo.getResource().getAbstract();
    List<String> kws=layerInfo.getResource().keywordValues();
    if (kws != null) {
      keywords=kws.toArray(new String[kws.size()]);
    }
  }
 else {
    LayerGroupInfo lgi=(LayerGroupInfo)layer;
    title=getTitle(lgi);
    description=getDescription(lgi);
    keywords=getKeyWords(lgi);
  }
  WMSMapContent context=new WMSMapContent(getMapRequest);
  context.setTitle(title);
  context.setAbstract(description);
  context.setKeywords(keywords);
  context.setMapWidth(getMapRequest.getWidth());
  context.setMapHeight(getMapRequest.getHeight());
  context.getViewport().setBounds((ReferencedEnvelope)getMapRequest.getBbox());
  MapContentWebMap webMap;
  try {
    webMap=(MapContentWebMap)new GetMap(wms).run(getMapRequest,context);
  }
 catch (  Exception e) {
    throw new RestletException(e.getMessage(),Status.SERVER_ERROR_INTERNAL,e);
  }
  KmlEncodingContext encodingContext=new KmlEncodingContext(webMap.getMapContent(),wms,true);
  KmlEncodingBundle kml=buildKml(encodingContext);
  DataFormat format=getFormatGet();
  Representation representation=format.toRepresentation(kml);
  Response response=getResponse();
  response.setEntity(representation);
}
