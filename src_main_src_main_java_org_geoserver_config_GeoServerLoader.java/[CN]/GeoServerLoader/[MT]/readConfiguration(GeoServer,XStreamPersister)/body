{
  Resource f=resourceLoader.get("services.xml");
  if (!Resources.exists(f)) {
    f=resourceLoader.get("global.xml");
    if (Resources.exists(f)) {
      GeoServerInfo global=depersist(xp,f,GeoServerInfo.class);
      geoServer.setGlobal(global);
    }
    f=resourceLoader.get("logging.xml");
    if (Resources.exists(f)) {
      LoggingInfo logging=depersist(xp,f,LoggingInfo.class);
      geoServer.setLogging(logging);
    }
    Resource workspaces=resourceLoader.get("workspaces");
    if (Resources.exists(workspaces)) {
      for (      Resource dir : workspaces.list()) {
        if (dir.getType() != Type.DIRECTORY)         continue;
        f=dir.get("settings.xml");
        if (Resources.exists(f)) {
          SettingsInfo settings=depersist(xp,f,SettingsInfo.class);
          geoServer.add(settings);
        }
      }
    }
    final List<XStreamServiceLoader> loaders=GeoServerExtensions.extensions(XStreamServiceLoader.class);
    loadServices(null,loaders,geoServer);
    if (workspaces != null) {
      for (      Resource dir : workspaces.list()) {
        if (dir.getType() != Type.DIRECTORY)         continue;
        loadServices(dir,loaders,geoServer);
      }
    }
  }
 else {
    GeoServerPersister p=new GeoServerPersister(resourceLoader,xp);
    geoServer.addListener(p);
    new LegacyConfigurationImporter(geoServer).imprt(resourceLoader.getBaseDirectory());
    geoServer.removeListener(p);
    f.renameTo(f.parent().get("services.xml.old"));
  }
}
