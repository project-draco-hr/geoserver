{
  File f=resourceLoader.find("services.xml");
  if (f == null) {
    f=resourceLoader.find("global.xml");
    if (f != null) {
      GeoServerInfo global=depersist(xp,f,GeoServerInfo.class);
      geoServer.setGlobal(global);
    }
    f=resourceLoader.find("logging.xml");
    if (f != null) {
      LoggingInfo logging=depersist(xp,f,LoggingInfo.class);
      geoServer.setLogging(logging);
    }
    File workspaces=resourceLoader.find("workspaces");
    if (workspaces != null) {
      for (      File dir : workspaces.listFiles()) {
        if (!dir.isDirectory() && !dir.isHidden())         continue;
        f=resourceLoader.find(dir,"settings.xml");
        if (f != null) {
          SettingsInfo settings=depersist(xp,f,SettingsInfo.class);
          geoServer.add(settings);
        }
      }
    }
    final List<XStreamServiceLoader> loaders=GeoServerExtensions.extensions(XStreamServiceLoader.class);
    loadServices(null,loaders,geoServer);
    if (workspaces != null) {
      for (      File dir : workspaces.listFiles()) {
        if (!dir.isDirectory() && !dir.isHidden())         continue;
        loadServices(dir,loaders,geoServer);
      }
    }
  }
 else {
    GeoServerPersister p=new GeoServerPersister(resourceLoader,xp);
    geoServer.addListener(p);
    new LegacyConfigurationImporter(geoServer).imprt(resourceLoader.getBaseDirectory());
    geoServer.removeListener(p);
    f.renameTo(new File(f.getParentFile(),"services.xml.old"));
  }
}
