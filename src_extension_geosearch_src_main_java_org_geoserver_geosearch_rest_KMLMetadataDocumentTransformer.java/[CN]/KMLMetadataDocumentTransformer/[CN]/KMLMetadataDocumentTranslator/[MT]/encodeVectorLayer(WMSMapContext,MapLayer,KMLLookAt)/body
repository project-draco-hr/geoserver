{
  SimpleFeatureSource featureSource=(SimpleFeatureSource)layer.getFeatureSource();
  SimpleFeatureCollection features=null;
  try {
    features=KMLUtils.loadFeatureCollection(featureSource,layer,mapContext,wms,scaleDenominator);
    if (features == null) {
      return;
    }
  }
 catch (  RuntimeException e) {
    throw e;
  }
catch (  Exception e) {
    throw new RuntimeException(e);
  }
  KMLVectorTransformer tx=createVectorTransformer(mapContext,layer,lookAtOpts);
  initTransformer(tx);
  tx.setScaleDenominator(scaleDenominator);
  Translator kmlTranslator=tx.createTranslator(contentHandler);
  kmlTranslator.encode(features);
}
