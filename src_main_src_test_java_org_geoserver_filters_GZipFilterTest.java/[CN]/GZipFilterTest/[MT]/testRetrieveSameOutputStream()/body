{
  MockHttpServletRequest request=new MockHttpServletRequest();
  request.setRequestURL("http://www.geoserver.org");
  request.setHeader("accept-encoding","gzip");
  MockHttpServletResponse response=new MockHttpServletResponse();
  response.setContentType("text/plain");
  GZIPFilter filter=new GZIPFilter();
  MockFilterConfig config=new MockFilterConfig();
  MockServletContext context=new MockServletContext();
  context.setInitParameter("compressed-types","text/plain");
  config.setupServletContext(context);
  filter.init(config);
  MockFilterChain chain=new MockFilterChain(){
    @Override public void doFilter(    ServletRequest request,    ServletResponse response) throws IOException, ServletException {
      AlternativesResponseStream alternatives=(AlternativesResponseStream)response.getOutputStream();
      GZIPResponseStream gzipStream=(GZIPResponseStream)alternatives.getStream();
      GZIPOutputStream os=gzipStream.gzipstream;
      try {
        Field f=FilterOutputStream.class.getDeclaredField("out");
        f.setAccessible(true);
        OutputStream wrapped=(OutputStream)f.get(os);
        assertTrue(wrapped instanceof MockServletOutputStream);
      }
 catch (      Exception e) {
        System.out.println("Failed to retrieve original stream wrapped by the GZIPOutputStream");
        e.printStackTrace();
      }
    }
  }
;
  filter.doFilter(request,response,chain);
}
