{
  if (wfs.isCiteCompliant()) {
    if (request.getUpdateSequence() != null) {
      throw new WFSException(request,"Invalid update sequence","InvalidUpdateSequence");
    }
  }
  if (wfs.isCiteCompliant()) {
    if (!request.isSetService()) {
      throw new WFSException("Service not set","MissingParameterValue","service");
    }
  }
  List<String> provided=new ArrayList<String>();
  provided.add("1.0.0");
  provided.add("1.1.0");
  provided.add("2.0.0");
  List<String> accepted=request.getAcceptVersions();
  String version=RequestUtils.getVersionPreOws(provided,accepted);
  final CapabilitiesTransformer capsTransformer;
  if ("1.0.0".equals(version)) {
    capsTransformer=new CapabilitiesTransformer.WFS1_0(wfs,catalog);
  }
 else   if ("1.1.0".equals(version)) {
    capsTransformer=new CapabilitiesTransformer.WFS1_1(wfs,catalog);
  }
 else   if ("2.0.0".equals(version)) {
    capsTransformer=new CapabilitiesTransformer.WFS2_0(wfs,catalog);
  }
 else {
    throw new WFSException(request,"Could not understand version:" + version);
  }
  capsTransformer.setEncoding(Charset.forName(wfs.getGeoServer().getGlobal().getCharset()));
  return capsTransformer;
}
