{
  if (q.getTypeName() != null && !q.getTypeName().equals(CSWRecordDescriptor.RECORD.getName().getLocalPart())) {
    throw new IOException(q.getTypeName() + " is not a supported type");
  }
  if (q.getNamespace() != null && !q.getNamespace().toString().equals(CSWRecordDescriptor.RECORD.getName().getNamespaceURI())) {
    throw new IOException(q.getNamespace() + ":" + q.getTypeName()+ " is not a supported type");
  }
  int startIndex=0;
  if (q.getStartIndex() != null) {
    startIndex=q.getStartIndex();
  }
  FeatureCollection records=new RecordsFeatureCollection(root,startIndex);
  if (q.getFilter() != null && q.getFilter() != Filter.INCLUDE) {
    records=new FilteringFeatureCollection<FeatureType,Feature>(records,q.getFilter());
  }
  if (q.getSortBy() != null && q.getSortBy().length > 0) {
    Feature[] features=(Feature[])records.toArray(new Feature[records.size()]);
    Comparator<Feature> comparator=ComplexComparatorFactory.buildComparator(q.getSortBy());
    Arrays.sort(features,comparator);
    records=new MemoryFeatureCollection(records.getSchema(),Arrays.asList(features));
  }
  if (q.getMaxFeatures() < Query.DEFAULT_MAX) {
    records=new MaxFeaturesFeatureCollection<FeatureType,Feature>(records,q.getMaxFeatures());
  }
  if (q.getProperties() != null && q.getProperties().size() > 0) {
    records=new RetypingFeatureCollection(records,q.getProperties());
  }
  return records;
}
