{
  GetMapRequest request=new GetMapRequest();
  CoordinateReferenceSystem crs=DefaultGeographicCRS.WGS84;
  ReferencedEnvelope bbox=new ReferencedEnvelope(new Envelope(-116.90673461649858211,-114.30988665660261461,32.07093728218402617,33.89032847348440214),crs);
  request.setBbox(bbox);
  request.setSRS("urn:x-ogc:def:crs:EPSG:4326");
  request.setFormat("image/png");
  final WMSMapContent map=new WMSMapContent(request);
  map.setMapWidth(300);
  map.setMapHeight(300);
  map.setBgColor(Color.red);
  map.setTransparent(false);
  map.getViewport().setBounds(bbox);
  StyleBuilder styleBuilder=new StyleBuilder();
  Catalog catalog=getCatalog();
  CoverageInfo ci=catalog.getCoverageByName(SystemTestData.MULTIBAND.getPrefix(),SystemTestData.MULTIBAND.getLocalPart());
  GridCoverage2DReader reader=(GridCoverage2DReader)ci.getGridCoverageReader(null,null);
  reader.getCoordinateReferenceSystem();
  final Envelope env=ci.boundingBox();
  final int[] bandIndices=new int[]{1,2,0,2,1};
  Parameter<int[]> bandIndicesParam=(Parameter<int[]>)AbstractGridFormat.BANDS.createValue();
  bandIndicesParam.setValue(bandIndices);
  List<GeneralParameterValue> paramList=new ArrayList<GeneralParameterValue>();
  paramList.add(bandIndicesParam);
  GeneralParameterValue[] readParams=paramList.toArray(new GeneralParameterValue[paramList.size()]);
  Layer sl=new CachedGridReaderLayer(reader,styleBuilder.createStyle(styleBuilder.createRasterSymbolizer()),readParams);
  map.addLayer(sl);
  RenderedImageMap imageMap=this.rasterMapProducer.produceMap(map);
  ImageAssert.assertEquals(new File("src/test/resources/org/geoserver/wms/map/direct-raster-expected.tif"),imageMap.getImage(),0);
  imageMap.dispose();
}
