{
  final CoordinateReferenceSystem sourceCRS=reader.getCrs();
  GeneralEnvelope envelope=new GeneralEnvelope(reader.getOriginalEnvelope());
  envelope.setCoordinateReferenceSystem(sourceCRS);
  if (!(subsettingCRS == null || CRS.equalsIgnoreMetadata(subsettingCRS,sourceCRS))) {
    try {
      envelope=CRS.transform(CRS.findMathTransform(reader.getCrs(),subsettingCRS),reader.getOriginalEnvelope());
      envelope.setCoordinateReferenceSystem(subsettingCRS);
    }
 catch (    Exception e) {
      final WCS20Exception exception=new WCS20Exception("Unable to initialize subsetting envelope",WCS20Exception.WCS20ExceptionCode.SubsettingCrsNotSupported,subsettingCRS.toWKT());
      exception.initCause(e);
      throw exception;
    }
  }
  final EList<DimensionSubsetType> dimensions=request.getDimensionSubset();
  if (dimensions == null || dimensions.size() <= 0) {
    return envelope;
  }
  if (dimensions.size() > 2) {
    throw new WCS20Exception("Invalid number of dimensions",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,Integer.toString(dimensions.size()));
  }
  final List<String> axesNames=envelopeDimensionsMapper.getAxesNames(envelope,true);
  final List<String> foundDimensions=new ArrayList<String>();
  final GeneralEnvelope sourceEnvelope=new GeneralEnvelope(reader.getOriginalEnvelope());
  for (  DimensionSubsetType dim : dimensions) {
    String dimension=dim.getDimension();
    if (dimension.startsWith("http://www.opengis.net/def/axis/OGC/0/")) {
      dimension=dimension.substring("http://www.opengis.net/def/axis/OGC/0/".length());
    }
 else     if (dimension.startsWith("http://opengis.net/def/axis/OGC/0/")) {
      dimension=dimension.substring("http://opengis.net/def/axis/OGC/0/".length());
    }
    if (dimension == null || dimension.length() <= 0 || !axesNames.contains(dimension)) {
      throw new WCS20Exception("Empty or wrong axis label provided",WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,dimension == null ? "Null" : dimension);
    }
    if (foundDimensions.contains(dimension)) {
      throw new WCS20Exception("Axis label already used during subsetting",WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,dimension);
    }
    foundDimensions.add(dimension);
    final String CRS=dim.getCRS();
    if (dim instanceof DimensionTrimType) {
      final DimensionTrimType trim=(DimensionTrimType)dim;
      final double low=Double.parseDouble(trim.getTrimLow());
      final double high=Double.parseDouble(trim.getTrimHigh());
      if (low > high) {
        throw new WCS20Exception("Low greater than High",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,trim.getTrimLow());
      }
      final int axisIndex=envelopeDimensionsMapper.getAxisIndex(envelope,dimension);
      if (axisIndex < 0) {
        throw new WCS20Exception("Invalid axis provided",WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,dimension);
      }
      envelope.setRange(axisIndex,low,high);
    }
 else     if (dim instanceof DimensionSliceType) {
      final DimensionSliceType slicing=(DimensionSliceType)dim;
      final String slicePointS=slicing.getSlicePoint();
      final double slicePoint=Double.parseDouble(slicePointS);
      final int axisIndex=envelopeDimensionsMapper.getAxisIndex(envelope,dimension);
      if (axisIndex < 0) {
        throw new WCS20Exception("Invalid axis provided",WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,dimension);
      }
      AffineTransform affineTransform=RequestUtils.getAffineTransform(reader.getOriginalGridToWorld(PixelInCell.CELL_CENTER));
      final double scale=axisIndex == 0 ? affineTransform.getScaleX() : -affineTransform.getScaleY();
      envelope.setRange(axisIndex,slicePoint,slicePoint + scale);
      if (sourceEnvelope.getMinimum(axisIndex) > slicePoint || slicePoint > sourceEnvelope.getMaximum(axisIndex)) {
        throw new WCS20Exception("SlicePoint outside coverage envelope",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,slicePointS);
      }
    }
 else {
      throw new WCS20Exception("Invalid element found while attempting to parse dimension subsetting request",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,dim.getClass().toString());
    }
  }
  if (CRS.equalsIgnoreMetadata(envelope.getCoordinateReferenceSystem(),sourceEnvelope.getCoordinateReferenceSystem())) {
    envelope.intersect(sourceEnvelope);
    envelope.setCoordinateReferenceSystem(reader.getCrs());
  }
 else {
    try {
      envelope=CRS.transform(CRS.findMathTransform(subsettingCRS,sourceCRS),envelope);
      envelope.setCoordinateReferenceSystem(sourceCRS);
      envelope.intersect(sourceEnvelope);
      envelope.setCoordinateReferenceSystem(sourceCRS);
    }
 catch (    Exception e) {
      final WCS20Exception exception=new WCS20Exception("Unable to initialize subsetting envelope",WCS20Exception.WCS20ExceptionCode.SubsettingCrsNotSupported,subsettingCRS.toWKT());
      exception.initCause(e);
      throw exception;
    }
  }
  if (envelope.isEmpty()) {
    throw new WCS20Exception("Empty intersection after subsetting",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"");
  }
  return envelope;
}
