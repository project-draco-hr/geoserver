{
  String authKeyUrlParam="myAuthKey";
  String filterName="testAuthKeyFilter1";
  AuthenticationKeyFilterConfig config=new AuthenticationKeyFilterConfig();
  config.setClassName(GeoServerAuthenticationKeyFilter.class.getName());
  config.setName(filterName);
  config.setUserGroupServiceName("ug1");
  config.setAuthKeyParamName(authKeyUrlParam);
  config.setAuthKeyMapperName("propertyMapper");
  getSecurityManager().saveFilter(config);
  GeoServerAuthenticationKeyFilter filter=(GeoServerAuthenticationKeyFilter)getSecurityManager().loadFilter(filterName);
  PropertyAuthenticationKeyMapper mapper=(PropertyAuthenticationKeyMapper)filter.getMapper();
  mapper.synchronize();
  prepareFilterChain(pattern,filterName);
  modifyChain(pattern,false,true,null);
  SecurityContextHolder.getContext().setAuthentication(null);
  MockHttpServletRequest request=createRequest("/foo/bar");
  MockHttpServletResponse response=new MockHttpServletResponse();
  MockFilterChain chain=new MockFilterChain();
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_FORBIDDEN,response.getErrorCode());
  String authKey=null;
  for (  Entry<Object,Object> entry : mapper.authKeyProps.entrySet()) {
    if (testUserName.equals(entry.getValue())) {
      authKey=(String)entry.getKey();
      break;
    }
  }
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.setQueryString(authKeyUrlParam + "=" + authKey);
  request.setupAddParameter(authKeyUrlParam,authKey);
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  assertFalse(response.wasRedirectSent());
  SecurityContext ctx=(SecurityContext)request.getSession(false).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNotNull(ctx);
  Authentication auth=ctx.getAuthentication();
  assertNotNull(auth);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  checkForAuthenticatedRole(auth);
  assertEquals(testUserName,auth.getPrincipal());
  username="unknown";
  password=username;
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.setQueryString(authKeyUrlParam + "=abc");
  request.setupAddParameter(authKeyUrlParam,"abc");
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_FORBIDDEN,response.getErrorCode());
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  username=testUserName;
  password=username;
  updateUser("ug1",username,false);
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.setQueryString(authKeyUrlParam + "=" + authKey);
  request.setupAddParameter(authKeyUrlParam,authKey);
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_FORBIDDEN,response.getErrorCode());
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  updateUser("ug1",username,true);
  insertAnonymousFilter();
  request=createRequest("foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getErrorCode());
  removeAnonymousFilter();
}
