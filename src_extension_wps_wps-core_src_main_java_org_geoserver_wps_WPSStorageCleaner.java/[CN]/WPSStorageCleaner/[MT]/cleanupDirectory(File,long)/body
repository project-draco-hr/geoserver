{
  for (  File f : directory.listFiles()) {
    if (lockedFiles.contains(f)) {
      continue;
    }
    if (f.isDirectory()) {
      cleanupDirectory(f,now);
      if (f.list().length == 0 && f.lastModified() > expirationDelay) {
        f.delete();
      }
    }
 else {
      if (expirationDelay > 0 && now - f.lastModified() > expirationDelay) {
        if (f.isFile()) {
          f.delete();
        }
      }
    }
  }
}
