{
  while (true) {
    Command command=commands.take();
    if (command.type == CommandType.Exit) {
      return (String)command.value;
    }
 else     if (command.type == CommandType.SetProgress) {
      listener.progress(((Number)command.value).floatValue());
    }
 else {
      ProcessException exception=(ProcessException)command.value;
      listener.exceptionOccurred(exception);
      throw exception;
    }
  }
}
