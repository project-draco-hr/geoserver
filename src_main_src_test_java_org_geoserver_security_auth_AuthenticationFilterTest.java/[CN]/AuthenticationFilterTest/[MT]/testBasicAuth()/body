{
  prepareFilterChain(pattern,testFilterName);
  modifyChain(pattern,false,true,null);
  SecurityContextHolder.getContext().setAuthentication(null);
  MockHttpServletRequest request=createRequest("/foo/bar");
  MockHttpServletResponse response=new MockHttpServletResponse();
  MockFilterChain chain=new MockFilterChain();
  getProxy().doFilter(request,response,chain);
  String tmp=response.getHeader("WWW-Authenticate");
  assertNotNull(tmp);
  assert(tmp.indexOf(GeoServerSecurityManager.REALM) != -1);
  assert(tmp.indexOf("Basic") != -1);
  assertEquals(HttpServletResponse.SC_UNAUTHORIZED,response.getStatus());
  SecurityContext ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNull(ctx);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  modifyChain(pattern,false,true,GeoServerSecurityFilterChain.ROLE_FILTER);
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.addHeader("Authorization","Basic " + new String(Base64.encodeBytes((testUserName + ":" + testPassword).getBytes())));
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getStatus());
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNotNull(ctx);
  Authentication auth=ctx.getAuthentication();
  assertNotNull(auth);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  checkForAuthenticatedRole(auth);
  assertEquals(testUserName,((UserDetails)auth.getPrincipal()).getUsername());
  assertTrue(auth.getAuthorities().contains(new GeoServerRole(rootRole)));
  assertTrue(auth.getAuthorities().contains(new GeoServerRole(derivedRole)));
  String roleString=response.getHeader(GeoServerRoleFilter.DEFAULT_HEADER_ATTRIBUTE);
  assertNotNull(roleString);
  String[] roles=roleString.split(";");
  assertEquals(3,roles.length);
  List<String> roleList=Arrays.asList(roles);
  assertTrue(roleList.contains(GeoServerRole.AUTHENTICATED_ROLE.getAuthority()));
  assertTrue(roleList.contains(rootRole));
  assertTrue(roleList.contains(derivedRole));
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.addHeader("Authorization","Basic " + new String(Base64.encodeBytes((testUserName + ":wrongpass").getBytes())));
  getProxy().doFilter(request,response,chain);
  tmp=response.getHeader("WWW-Authenticate");
  assertNotNull(tmp);
  assert(tmp.indexOf(GeoServerSecurityManager.REALM) != -1);
  assert(tmp.indexOf("Basic") != -1);
  assertEquals(HttpServletResponse.SC_UNAUTHORIZED,response.getStatus());
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNull(ctx);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.addHeader("Authorization","Basic " + new String(Base64.encodeBytes(("unknwon:" + testPassword).getBytes())));
  getProxy().doFilter(request,response,chain);
  tmp=response.getHeader("WWW-Authenticate");
  assertNotNull(tmp);
  assert(tmp.indexOf(GeoServerSecurityManager.REALM) != -1);
  assert(tmp.indexOf("Basic") != -1);
  assertEquals(HttpServletResponse.SC_UNAUTHORIZED,response.getStatus());
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNull(ctx);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.addHeader("Authorization","Basic " + new String(Base64.encodeBytes((GeoServerUser.ROOT_USERNAME + ":" + getMasterPassword()).getBytes())));
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getStatus());
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  auth=ctx.getAuthentication();
  assertNotNull(auth);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  assertEquals(GeoServerUser.ROOT_USERNAME,auth.getPrincipal());
  assertTrue(auth.getAuthorities().size() == 1);
  assertTrue(auth.getAuthorities().contains(GeoServerRole.ADMIN_ROLE));
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.addHeader("Authorization","Basic " + new String(Base64.encodeBytes((GeoServerUser.ROOT_USERNAME + ":geoserver1").getBytes())));
  getProxy().doFilter(request,response,chain);
  tmp=response.getHeader("WWW-Authenticate");
  assertNotNull(tmp);
  assert(tmp.indexOf(GeoServerSecurityManager.REALM) != -1);
  assert(tmp.indexOf("Basic") != -1);
  assertEquals(HttpServletResponse.SC_UNAUTHORIZED,response.getStatus());
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNull(ctx);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  getSecurityManager().getAuthenticationCache().removeAll();
  updateUser("ug1",testUserName,false);
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  request.addHeader("Authorization","Basic " + new String(Base64.encodeBytes((testUserName + ":" + testPassword).getBytes())));
  getProxy().doFilter(request,response,chain);
  tmp=response.getHeader("WWW-Authenticate");
  assertNotNull(tmp);
  assert(tmp.indexOf(GeoServerSecurityManager.REALM) != -1);
  assert(tmp.indexOf("Basic") != -1);
  assertEquals(HttpServletResponse.SC_UNAUTHORIZED,response.getStatus());
  ctx=(SecurityContext)request.getSession(true).getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);
  assertNull(ctx);
  assertNull(SecurityContextHolder.getContext().getAuthentication());
  updateUser("ug1",testUserName,true);
  insertAnonymousFilter();
  request=createRequest("/foo/bar");
  response=new MockHttpServletResponse();
  chain=new MockFilterChain();
  getProxy().doFilter(request,response,chain);
  assertEquals(HttpServletResponse.SC_OK,response.getStatus());
  removeAnonymousFilter();
}
