{
  String[][] headers=response.getHeaders(result,opDescriptor);
  boolean contentDispositionProvided=false;
  if (headers != null) {
    for (int i=0; i < headers.length; i++) {
      if (headers[i][0].equalsIgnoreCase("Content-Disposition")) {
        contentDispositionProvided=true;
      }
      req.getHttpResponse().addHeader(headers[i][0],headers[i][1]);
    }
  }
  if (!contentDispositionProvided) {
    String fname=response.getAttachmentFileName(result,opDescriptor);
    if (fname != null) {
      String disposition=null;
      Map rawKvp=req.getRawKvp();
      if (rawKvp != null) {
        disposition=(String)rawKvp.get("CONTENT-DISPOSITION");
        boolean valid=Response.DISPOSITION_ATTACH.equals(disposition) || Response.DISPOSITION_INLINE.equals(disposition);
        if (!valid) {
          disposition=null;
        }
      }
      if (disposition == null) {
        disposition=response.getPreferredDisposition(result,opDescriptor);
      }
      String disp=disposition + "; filename=" + fname;
      req.getHttpResponse().setHeader("Content-Disposition",disp);
    }
  }
}
