{
  if (!isVectorLayer(mapLayer))   return 1;
  Envelope originalBounds=mapContext.getRequest().getBbox();
  mapContext.getRequest().setBbox(bounds);
  mapContext.setAreaOfInterest(new ReferencedEnvelope(bounds,DefaultGeographicCRS.WGS84));
  String originalRegionateBy=null;
  if (regionate) {
    originalRegionateBy=(String)mapContext.getRequest().getFormatOptions().get("regionateby");
    if (originalRegionateBy == null)     mapContext.getRequest().getFormatOptions().put("regionateby","auto");
  }
  int numFeatures=0;
  try {
    final SimpleFeatureCollection fc=KMLUtils.loadFeatureCollection((SimpleFeatureSource)mapLayer.getFeatureSource(),mapLayer,mapContext,wms,-1);
    numFeatures=fc == null ? 0 : fc.size();
  }
 catch (  ServiceException e) {
    LOGGER.severe("Caught the WmsException!");
    numFeatures=-1;
  }
catch (  HttpErrorCodeException e) {
    if (e.getErrorCode() == 204) {
      throw e;
    }
 else {
      LOGGER.log(Level.WARNING,"Failure while checking whether a regionated child tile " + "contained features!",e);
    }
  }
catch (  Exception e) {
    LOGGER.log(Level.WARNING,"Failure while checking whether a regionated child tile contained features!",e);
  }
  mapContext.getRequest().setBbox(originalBounds);
  mapContext.setAreaOfInterest(new ReferencedEnvelope(originalBounds,DefaultGeographicCRS.WGS84));
  if (regionate && originalRegionateBy == null) {
    mapContext.getRequest().getFormatOptions().remove("regionateby");
  }
  return numFeatures;
}
