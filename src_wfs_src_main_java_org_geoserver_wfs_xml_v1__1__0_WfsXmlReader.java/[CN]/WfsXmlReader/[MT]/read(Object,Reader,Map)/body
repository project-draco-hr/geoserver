{
  Boolean strict=(Boolean)kvp.get("strict");
  if (strict == null) {
    strict=Boolean.FALSE;
  }
  if (wfs.isCiteCompliant()) {
    strict=Boolean.TRUE;
  }
  configuration.getProperties().add(Parser.Properties.PARSE_UNKNOWN_ELEMENTS);
  Parser parser=new Parser(configuration);
  parser.setValidating(strict.booleanValue());
  List<NamespaceInfo> namespaces=catalog.getNamespaces();
  for (  NamespaceInfo ns : namespaces) {
    if (ns.equals(catalog.getDefaultNamespace()))     continue;
    parser.getNamespaces().declarePrefix(ns.getPrefix(),ns.getURI());
  }
  InputSource source=new InputSource(reader);
  source.setEncoding(wfs.getGeoServer().getGlobal().getCharset());
  Object parsed=parser.parse(source);
  if (!"Transaction".equalsIgnoreCase(getElement().getLocalPart())) {
    if (!parser.getValidationErrors().isEmpty()) {
      WFSException exception=new WFSException("Invalid request","InvalidParameterValue");
      for (Iterator e=parser.getValidationErrors().iterator(); e.hasNext(); ) {
        Exception error=(Exception)e.next();
        exception.getExceptionText().add(error.getLocalizedMessage());
      }
      throw exception;
    }
  }
  return parsed;
}
