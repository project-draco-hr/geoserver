{
  String principal=super.getPreAuthenticatedPrincipal(request);
  HttpSession session=request.getSession(false);
  if (session == null && Boolean.TRUE.equals(request.getAttribute(GeoServerSecurityContextPersistenceFilter.ALLOWSESSIONCREATION_ATTR))) {
    session=request.getSession();
    LOGGER.info("Http session created by CAS");
  }
  if (principal != null && session != null) {
    session.setAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY,request.getAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY));
    request.removeAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY);
    getHandler().recordSession(request);
  }
  if (principal == null) {
    request.removeAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY);
  }
  return principal;
}
