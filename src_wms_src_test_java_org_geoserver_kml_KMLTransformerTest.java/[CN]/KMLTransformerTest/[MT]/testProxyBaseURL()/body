{
  GeoServer gs=getGeoServer();
  try {
    GeoServerInfo info=gs.getGlobal();
    info.setProxyBaseUrl("http://myhost:9999/gs");
    gs.save(info);
    Layer layer=createMapLayer(MockData.POINTS,"Bridge");
    FeatureSource<SimpleFeatureType,SimpleFeature> featureSource;
    featureSource=(FeatureSource<SimpleFeatureType,SimpleFeature>)layer.getFeatureSource();
    int nfeatures=featureSource.getFeatures().size();
    WMSMapContext mapContext=new WMSMapContext(createGetMapRequest(MockData.POINTS));
    Document document;
    try {
      mapContext.addLayer(layer);
      KMLVectorTransformer transformer=new KMLVectorTransformer(getWMS(),mapContext,layer);
      transformer.setIndentation(2);
      document=WMSTestSupport.transform(featureSource.getFeatures(),transformer);
    }
  finally {
      mapContext.dispose();
    }
    XMLAssert.assertXpathEvaluatesTo("http://myhost:9999/gs/styles/bridge.png","//Style/IconStyle/Icon/href",document);
  }
  finally {
    GeoServerInfo info=gs.getGlobal();
    info.setProxyBaseUrl(null);
    gs.save(info);
  }
}
