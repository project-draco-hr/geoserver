{
  if (LOGGER.isLoggable(Level.FINE)) {
    LOGGER.fine("Getting a writer for tiff");
  }
  final ImageWriter writer=writerSPI.createWriterInstance();
  final ImageOutputStream ioutstream=ImageIOExt.createImageOutputStream(image,outStream);
  if (ioutstream == null)   throw new ServiceException("Unable to create ImageOutputStream.");
  if (LOGGER.isLoggable(Level.FINE)) {
    LOGGER.fine("Writing tiff image ...");
  }
  GetMapRequest request=mapContent.getRequest();
  final String format=request.getFormat();
  if (format.equalsIgnoreCase(IMAGE_TIFF8) || (mapContent.getPaletteInverter() != null)) {
    InverseColorMapOp paletteInverter=mapContent.getPaletteInverter();
    image=forceIndexed8Bitmask(image,paletteInverter);
  }
  try {
    writer.setOutput(ioutstream);
    writer.write(image);
  }
  finally {
    try {
      ioutstream.close();
    }
 catch (    Throwable e) {
      if (LOGGER.isLoggable(Level.FINEST))       LOGGER.log(Level.FINEST,"Unable to properly close output stream",e);
    }
    try {
      writer.dispose();
    }
 catch (    Throwable e) {
      if (LOGGER.isLoggable(Level.FINEST))       LOGGER.log(Level.FINEST,"Unable to properly dispose writer",e);
    }
  }
  if (LOGGER.isLoggable(Level.FINE)) {
    LOGGER.fine("Writing tiff image done!");
  }
}
