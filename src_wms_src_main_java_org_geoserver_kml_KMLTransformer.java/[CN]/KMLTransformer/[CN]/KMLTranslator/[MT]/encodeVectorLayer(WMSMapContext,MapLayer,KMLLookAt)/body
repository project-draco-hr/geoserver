{
  SimpleFeatureSource featureSource=(SimpleFeatureSource)layer.getFeatureSource();
  SimpleFeatureCollection features=null;
  try {
    features=KMLUtils.loadFeatureCollection(featureSource,layer,mapContext,wms,scaleDenominator);
    if (features == null) {
      return;
    }
  }
 catch (  RuntimeException e) {
    throw e;
  }
catch (  Exception e) {
    throw new RuntimeException(e);
  }
  if (kmz) {
    int kmscore=wms.getKmScore();
    Object kmScoreObj=mapContext.getRequest().getFormatOptions().get("kmscore");
    if (kmScoreObj != null) {
      kmscore=(Integer)kmScoreObj;
    }
    boolean useVector=useVectorOutput(kmscore,features.size());
    if (useVector) {
      KMLVectorTransformer tx=createVectorTransformer(mapContext,layer,lookAtOpts);
      initTransformer(tx);
      tx.setScaleDenominator(scaleDenominator);
      tx.createTranslator(contentHandler).encode(features);
    }
 else {
      KMLRasterTransformer tx=createRasterTransfomer(mapContext,lookAtOpts);
      initTransformer(tx);
      tx.setInline(true);
      tx.createTranslator(contentHandler).encode(layer);
    }
  }
 else {
    KMLVectorTransformer tx=createVectorTransformer(mapContext,layer,lookAtOpts);
    initTransformer(tx);
    tx.setScaleDenominator(scaleDenominator);
    tx.createTranslator(contentHandler).encode(features);
  }
}
