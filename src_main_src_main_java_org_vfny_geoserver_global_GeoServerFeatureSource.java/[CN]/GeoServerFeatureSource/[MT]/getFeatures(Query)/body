{
  SortBy[] sortBy=query.getSortBy();
  if (sortBy != null && sortBy != SortBy.UNSORTED) {
    if (!source.getQueryCapabilities().supportsSorting(sortBy)) {
      query.setSortBy(null);
    }
 else {
      sortBy=null;
    }
  }
  Integer offset=null, maxFeatures=null;
  if (query.getStartIndex() != null) {
    if (!source.getQueryCapabilities().isOffsetSupported()) {
      offset=query.getStartIndex();
      maxFeatures=query.getMaxFeatures();
      query.setStartIndex(null);
      query.setMaxFeatures(Query.DEFAULT_MAX);
    }
  }
  Query reprojected=reprojectFilter(query);
  Query newQuery=adaptQuery(reprojected,schema);
  CoordinateReferenceSystem targetCRS=query.getCoordinateSystemReproject();
  try {
    SimpleFeatureCollection fc=source.getFeatures(newQuery);
    if (sortBy != null) {
      fc=new SortedSimpleFeatureCollection(fc,sortBy);
    }
    if (offset != null) {
      fc=new MaxSimpleFeatureCollection(fc,offset,maxFeatures);
    }
    return applyProjectionPolicies(targetCRS,fc);
  }
 catch (  Exception e) {
    throw new DataSourceException(e);
  }
}
