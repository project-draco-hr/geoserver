{
  if (!gwc.getConfig().isDirectWMSIntegrationEnabled()) {
    return (WebMap)invocation.proceed();
  }
  final Method method=invocation.getMethod();
  Assert.isTrue(method.getDeclaringClass().equals(WebMapService.class));
  Assert.isTrue("getMap".equals(method.getName()));
  final Object[] arguments=invocation.getArguments();
  Assert.isTrue(arguments.length == 1);
  Assert.isInstanceOf(GetMapRequest.class,arguments[0]);
  final GetMapRequest request=(GetMapRequest)arguments[0];
  boolean tiled=request.isTiled();
  if (!tiled) {
    return (WebMap)invocation.proceed();
  }
  ConveyorTile cachedTile=gwc.dispatch(request);
  if (cachedTile != null) {
    if (LOGGER.isLoggable(Level.FINEST)) {
      LOGGER.finest("GetMap request intercepted, serving cached content: " + request);
    }
    final String ifNoneMatch=request.getHttpRequestHeader("If-None-Match");
    final String hexTag=Long.toHexString(cachedTile.getTSCreated());
    if (hexTag.equals(ifNoneMatch)) {
      LOGGER.finer("ETag matches, returning 304");
      throw new HttpErrorCodeException(HttpServletResponse.SC_NOT_MODIFIED);
    }
    LOGGER.finer("No matching ETag, returning cached tile");
    final String mimeType=cachedTile.getMimeType().getMimeType();
    RawMap map;
    final Resource mapContents=cachedTile.getBlob();
    if (mapContents instanceof ByteArrayResource) {
      byte[] mapBytes;
      mapBytes=((ByteArrayResource)mapContents).getContents();
      map=new RawMap(null,mapBytes,mimeType);
    }
 else {
      ByteArrayOutputStream out=new ByteArrayOutputStream();
      mapContents.transferTo(Channels.newChannel(out));
      map=new RawMap(null,out,mimeType);
    }
    map.setResponseHeader("Cache-Control","no-cache");
    map.setResponseHeader("ETag",Long.toHexString(cachedTile.getTSCreated()));
    map.setResponseHeader("geowebcache-tile-index",Arrays.toString(cachedTile.getTileIndex()));
    return map;
  }
  return (WebMap)invocation.proceed();
}
