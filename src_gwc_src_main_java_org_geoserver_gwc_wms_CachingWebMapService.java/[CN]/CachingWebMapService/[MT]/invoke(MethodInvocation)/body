{
  if (!gwc.getConfig().isDirectWMSIntegrationEnabled()) {
    return (WebMap)invocation.proceed();
  }
  final GetMapRequest request=getRequest(invocation);
  boolean tiled=request.isTiled();
  if (!tiled) {
    return (WebMap)invocation.proceed();
  }
  final StringBuilder requestMistmatchTarget=new StringBuilder();
  ConveyorTile cachedTile=gwc.dispatch(request,requestMistmatchTarget);
  if (cachedTile == null) {
    WebMap dynamicResult=(WebMap)invocation.proceed();
    dynamicResult.setResponseHeader("geowebcache-cache-result",MISS.toString());
    dynamicResult.setResponseHeader("geowebcache-miss-reason",requestMistmatchTarget.toString());
    return dynamicResult;
  }
  checkState(cachedTile.getTileLayer() != null);
  final TileLayer layer=cachedTile.getTileLayer();
  if (LOGGER.isLoggable(Level.FINEST)) {
    LOGGER.finest("GetMap request intercepted, serving cached content: " + request);
  }
  final byte[] tileBytes;
{
    final Resource mapContents=cachedTile.getBlob();
    if (mapContents instanceof ByteArrayResource) {
      tileBytes=((ByteArrayResource)mapContents).getContents();
    }
 else {
      ByteArrayOutputStream out=new ByteArrayOutputStream();
      mapContents.transferTo(Channels.newChannel(out));
      tileBytes=out.toByteArray();
    }
  }
  final String ifNoneMatch=request.getHttpRequestHeader("If-None-Match");
  final byte[] hash=MessageDigest.getInstance("MD5").digest(tileBytes);
  final String etag=toHexString(hash);
  if (etag.equals(ifNoneMatch)) {
    LOGGER.finer("ETag matches, returning 304");
    throw new HttpErrorCodeException(HttpServletResponse.SC_NOT_MODIFIED);
  }
  LOGGER.finer("No matching ETag, returning cached tile");
  final String mimeType=cachedTile.getMimeType().getMimeType();
  RawMap map=new RawMap(null,tileBytes,mimeType);
  map.setResponseHeader("Cache-Control","no-cache");
  map.setResponseHeader("ETag",etag);
  map.setContentDispositionHeader(null,"." + cachedTile.getMimeType().getFileExtension());
  long[] tileIndex=cachedTile.getTileIndex();
  CacheResult cacheResult=cachedTile.getCacheResult();
  GridSubset gridSubset=layer.getGridSubset(cachedTile.getGridSetId());
  BoundingBox tileBounds=gridSubset.boundsFromIndex(tileIndex);
  String cacheResultHeader=cacheResult == null ? "UNKNOWN" : cacheResult.toString();
  map.setResponseHeader("geowebcache-cache-result",cacheResultHeader);
  map.setResponseHeader("geowebcache-tile-index",Arrays.toString(tileIndex));
  map.setResponseHeader("geowebcache-tile-bounds",tileBounds.toString());
  map.setResponseHeader("geowebcache-gridset",gridSubset.getName());
  map.setResponseHeader("geowebcache-crs",gridSubset.getSRS().toString());
  return map;
}
