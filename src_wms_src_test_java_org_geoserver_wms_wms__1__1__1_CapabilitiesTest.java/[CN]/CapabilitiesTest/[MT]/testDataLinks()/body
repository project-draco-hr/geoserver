{
  String layerName=MockData.POINTS.getPrefix() + ":" + MockData.POINTS.getLocalPart();
  LayerInfo layer=getCatalog().getLayerByName(MockData.POINTS.getLocalPart());
  DataLinkInfo mdlink=getCatalog().getFactory().createDataLink();
  mdlink.setContent("http://geoserver.org");
  mdlink.setType("text/xml");
  ResourceInfo resource=layer.getResource();
  resource.getDataLinks().add(mdlink);
  getCatalog().save(resource);
  Document doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.1.1",true);
  String xpath="//Layer[Name='" + layerName + "']/DataURL/Format";
  assertXpathEvaluatesTo("text/xml",xpath,doc);
  xpath="//Layer[Name='" + layerName + "']/DataURL/OnlineResource/@xlink:type";
  assertXpathEvaluatesTo("simple",xpath,doc);
  xpath="//Layer[Name='" + layerName + "']/DataURL/OnlineResource/@xlink:href";
  assertXpathEvaluatesTo("http://geoserver.org",xpath,doc);
  GeoServerInfo global=getGeoServer().getGlobal();
  String proxyBaseUrl=global.getSettings().getProxyBaseUrl();
  mdlink.setContent("/metadata");
  getCatalog().save(resource);
  doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.1.1",true);
  assertXpathEvaluatesTo(proxyBaseUrl + "/metadata",xpath,doc);
  String query="key=value";
  mdlink.setContent("/metadata?" + query);
  getCatalog().save(resource);
  doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.1.1",true);
  assertXpathEvaluatesTo(proxyBaseUrl + "/metadata?" + query,xpath,doc);
  mdlink.setContent("http://localhost/metadata?" + query);
  getCatalog().save(resource);
  doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.1.1",true);
  assertXpathEvaluatesTo("http://localhost/metadata?" + query,xpath,doc);
}
